<?xml version="1.0" ?>
<layer-spec xmlns="urn:jboss:galleon:layer-spec:1.0"
            name="bw-common">
    <dependencies>
        <layer name="datasources-web-server"/>
        <layer name="jms-activemq"/>
        <layer name="webservices"/>
    </dependencies>

    <feature spec="subsystem.elytron.ldap-realm">
        <param name="ldap-realm" value="bedeworkRealm"/>
        <param name="identity-mapping" value="{rdn-identifier=uid, search-base-dn=&quot;ou=accounts,dc=bedework,dc=org&quot;}"/>
        <param name="attribute-mapping" value="{from=uid, to=Roles, filter=&quot;(uniqueMember={1})&quot;,filter-base-dn=&quot;ou=groups,dc=bedework,dc=org&quot;}"/>
    </feature>

    <feature spec="subsystem.elytron.mappers.simple-role-decoder">
        <param name="simple-role-decoder" value=""/>
    </feature>

    <feature spec="subsystem.elytron.security-domain">
        <param name="security-domain" value="bedeworkSD"/>
        <param name="default-realm" value="bedeworkRealm"/>
        <param name="permission-mapper" value="default-permission-mapper"/>
        <param name="security-event-listener" value="local-audit"/>
        <param name="realms" value="[{realm=bedeworkRealm,role-decoder=from-roles-attribute}]"/>
    </feature>

    <feature spec="subsystem.elytron.constant-realm-mapper">
        <param name="constant-realm-mapper" value="keycloak-oidc-realm-mapper"/>
        <param name="realm-name" value="KeycloakOIDCRealm"/>
    </feature>
    <feature spec="subsystem.elytron.service-loader-http-server-mechanism-factory">
        <param name="service-loader-http-server-mechanism-factory" value="keycloak-oidc-http-server-mechanism-factory"/>
        <param name="module" value="org.keycloak.keycloak-wildfly-elytron-oidc-adapter"/>
    </feature>
    <feature spec="subsystem.elytron.aggregate-http-server-mechanism-factory">
        <param name="aggregate-http-server-mechanism-factory" value="keycloak-http-server-mechanism-factory"/>
        <param name="http-server-mechanism-factories" value="[keycloak-oidc-http-server-mechanism-factory, global]"/>
    </feature>
    <feature spec="subsystem.elytron.http-authentication-factory">
        <param name="http-authentication-factory" value="keycloak-http-authentication"/>
        <param name="http-server-mechanism-factory" value="keycloak-http-server-mechanism-factory"/>
        <param name="security-domain" value="KeycloakDomain"/>
        <param name="mechanism-configurations" value="[{mechanism-name=KEYCLOAK,mechanism-realm-configurations=[{realm-name=KeycloakOIDCRealm,realm-mapper=keycloak-oidc-realm-mapper}]}]"/>
    </feature>
    <feature spec="subsystem.undertow">
        <feature spec="subsystem.undertow.application-security-domain">
            <param name="application-security-domain" value="other" />
            <unset param="security-domain"/>
            <param name="http-authentication-factory" value="keycloak-http-authentication"/>
        </feature>
    </feature>

    <feature spec="subsystem.datasources">
        <feature spec="subsystem.datasources.data-source">
            <param name="data-source"           value="ProcessEngine"/>
            <param name="enabled"               value="true"/>
            <param name="use-java-context"      value="true"/>
            <param name="jndi-name"             value="java:jboss/datasources/ProcessEngine"/>
            <param name="connection-url"        value="&quot;jdbc:h2:./camunda-h2-dbs/process-engine;DB_CLOSE_DELAY=-1;MVCC=TRUE;DB_CLOSE_ON_EXIT=FALSE&quot;"/>
            <param name="driver-name"           value="h2"/>
            <param name="user-name"             value="sa"/>
            <param name="password"              value="sa"/>
            <param name="jta"                   value="true"/>
            <param name="transaction-isolation" value="TRANSACTION_READ_COMMITTED" />
        </feature>
    </feature>
</layer-spec>